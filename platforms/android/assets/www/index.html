<!DOCTYPE html>
<html>
  <head>
    <title>Bootstrap 101 Template</title>
    <meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="assets/js/html5shiv.js"></script>
      <script src="assets/js/respond.min.js"></script>
    <![endif]-->
    <style type="text/css">
    #img-preview
    {
        width: 100%;
        max-width: 270px;
    }
    </style>
  </head>
  <!--
  nombre
  rut

-->
  <body>
    <div class="container">
        <div class="row">

            <div class="col-md-6">
                <form role="form">
                  <div class="form-group">
                    <label for="f_name">Nombre</label>
                    <input type="text" class="form-control" id="f_name" placeholder="Nombre de cliente">
                  </div>
                  <div class="form-group">
                    <label for="f_apellido">Apellido</label>
                    <input type="text" class="form-control" id="f_apellido" placeholder="Apellido de cliente">
                  </div>
                  <div class="form-group">
                    <label for="f_rut">Rut</label>
                    <input type="text" class="form-control" id="f_rut" placeholder="Rut de cliente">
                  </div>
                  <div class="form-group">
                    <label for="f_email">Correo electr√≥nico</label>
                    <input type="email" class="form-control" id="f_email" placeholder="Email">
                  </div>
                  <div class="form-group">
                    <label for="f_edad">Edad</label>
                    <input type="number" class="form-control" id="f_edad" min="0" max="90" step="1" value="18">
                  </div>
                  <div class="form-group">
                    <label for="f_sexo">Sexo</label>
                    <div class="radio">
                        <label>
                            <input type="radio" name="sexo" id="sexoH" value="H" checked>
                            Hombre
                        </label>
                    </div>
                    <div class="radio">
                        <label>
                            <input type="radio" name="sexo" id="sexoM" value="M">
                            Mujer
                        </label>
                    </div>
                  </div>
                </form>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <a href="#" class="thumbnail" id="f_foto">
                        <img id="img-preview">
                    </a>
                    
                    <center><label for="f_foto">Toque para tomar foto</label></center>
                </div>
                <button class="btn btn-primary btn-lg btn-block" id="btn_reg">Registrar</button>
                <button class="btn btn-success btn-lg btn-block" id="btn_download">Bajar foto</button>
                <button class="btn btn-danger btn-lg btn-block" id="btn_sync">Sincronizar con el servidor</button>
            </div>
        </div>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="js/jquery.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/holder.js"></script>
    <script type="text/javascript" src="phonegap.js"></script>
    <script type="text/javascript" src="js/Blob.js"></script>
    <script type="text/javascript" src="js/canvas-toBlob.js"></script>
    <script type="text/javascript" src="js/FileSaver.js"></script>
    <script type="text/javascript">

    var height_placeholder = 0;
    var lastSyncTimeStamp = 0;
    function errorhandler()
    {
        alert("db error!");
    }
    function successhandler()
    {
        //console.log("ok");
        alert("good");
    }
    function nullHandler() {}
    /*
    function querySuccess(tx, results)
    {
        alert(results.insertId);
    }
    */
    function opendb()
    {
        return window.openDatabase("usersdb", "1.0", "Users DB", 2*1024*1024);
    }
    function clear_form()
    {
        $("input[type='text']").val("");
        $("#f_edad, #f_email").val("");

        $("#img-preview").attr("src", "js/holder.js/100%x"+height_placeholder);
        Holder.run();
    }

    $(function()
    {
        height_placeholder = $("#img-preview").width() / 9 * 16;
        $("#img-preview").attr("data-src", "js/holder.js/100%x"+height_placeholder);
        Holder.run();

        $("#btn_download").on("click", function(ev)
        {
            try
            {
                console.log("btn on click");
                ev.preventDefault();
               var img = new Image();
                img.src = $("#img-preview").attr("src");
                img.onload = function () 
                {
                    //console.log("image onload");
                    var canvas = document.createElement("canvas");
                    canvas.width =this.width;
                    canvas.height =this.height;

                    var ctx = canvas.getContext("2d");
                    ctx.drawImage(this, 0, 0);


                    canvas.toBlob(function(blob)
                    {
                        saveAs(blob, "pic.png");
                    });
                }; 
            }
            catch(e)
            {
                alert(e);
            }
        });
        $("#btn_clean").on("click", function(ev)
        {
            clear_form();
        });

        $("#f_foto").on("click", function(ev)
        {
            try
            {
                ev.preventDefault();
                var onSuccess = function(imageURI)
                {
                    $("#img-preview").attr("src", imageURI);
                };
                var onFail = function(msg)
                {
                    alert(msg);
                };
                navigator.camera.getPicture(onSuccess, onFail, { quality: 50, destinationType: navigator.camera.DestinationType.FILE_URI, correctOrientation: true, saveToPhotoAlbum: true, targetHeight: -1, targetWidth: $("#img-preview").width()*2, cameraDirection: navigator.camera.Direction.BACK });
            }
            catch(e)
            {
                alert(e);
            }
            return false;

        });
        $("#btn_reg").click(function(ev)
        {
            var nombre =    $("#f_name").val();
            var rut =       $("#f_rut").val();
            var apellido =  $("#f_apellido").val();
            var edad =      $("#f_edad").val();
            var sexo =      $("input[name='sexo']").val();
            var email =     $("#f_email").val();

            var img = new Image();
            img.src = $("#img-preview").attr("src");
            img.onload = function () 
            {
                alert("onload");
                var canvas = document.createElement("canvas");
                canvas.width  = this.width;
                canvas.height = this.height;

                var ctx = canvas.getContext("2d");
                ctx.drawImage(this, 0, 0);


                var dataURL = canvas.toDataURL("image/png");

                var foto = dataURL.replace(/^data:image\/(png|jpg);base64,/, "");

                opendb().transaction(function(tx)
                {
                    try
                    {
                            alert("transaction");
                            tx.executeSql('INSERT INTO users (rut, nombre, apellido, foto, email, edad, sexo, ts) VALUES (?,?,?,?,?,?,?,?)', [rut, nombre, apellido, foto, email, edad, sexo, (new Date()).getTime()],
                            function(t, res)
                            {
                                alert("success");
                                //console.log("Insert id: " + res.insertId);
                            }, errorhandler);

                    }
                    catch(exc)
                    {
                        alert(exc);
                    }
                }, errorhandler, function()
                {
                    alert("Cliente ingresado.");
                    clear_form();
                });
            };
        });
        $("#btn_sync").click(function(ev)
        {
            opendb().readTransaction(function(tx)
            {
                alert("readTransaction");
                tx.executeSql('SELECT * FROM users WHERE ts > ?', [lastSyncTimeStamp],
                    function(t, res)
                    {
                        var tmp_lastSyncTimeStamp = 0;
                        var sendarr = [];
                        for (var i = 0; i < res.rows.length; i++)
                        {
                            var it = res.rows.item(i);
                            sendarr.push(it);
                            tmp_lastSyncTimeStamp = Math.max(lastSyncTimeStamp, it.ts);
                        }
                        $.ajax({
                            url: "http://186.64.120.145:5000/userdb/sync",
                            dataType: "json",
                            type: "post",
                            data:
                            {
                                jsondata: JSON.stringify(sendarr)
                            },
                            success: function(obj)
                            {
                                if (obj.success)
                                {
                                    lastSyncTimeStamp = tmp_lastSyncTimeStamp;

                                }
                            }
                        });
                    }, 
                    function(t, err)
                    {
                        alert("asdf");
                    }
                 );
            });
        });
        

        document.addEventListener("deviceready", function()
        {
            opendb().transaction(function(tx)
            {
                //alert("creando bdd");
                tx.executeSql("DROP TABLE users", [], function()
                {
                    //alert(":D");
                    tx.executeSql("CREATE TABLE users (rut TEXT, nombre TEXT, apellido TEXT, foto TEXT, email TEXT, edad TEXT, sexo TEXT, ts INTEGER)", [], function() { alert(":D"); }, function() { alert(":C"); });
                }, function() { alert(":C"); });
            }, errorhandler, successhandler);
        },false);
    });
    </script>
  </body>
</html>